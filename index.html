<!DOCTYPE html>
 <html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Etch-a-Sketch</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div id="header">
            <input id="resetInput" value="Start" type="button">
            <input id="randomInput" value="Random" type="button">
        </div>

        <div id = "container" >
        </div>

        <div id = "footer">
            <P>A project by Sasoun Torossian. 2020</P>
        </div>

        <script>
            let activeMouse = false
            let defaultColour = "white"

            // Event listener for handing mousedown. Toggles draw on
            let containerID = document.getElementById("container")
            containerID.addEventListener('mousedown', e => {
                clearSelection()
                if (!e.button) activeMouse = true
            })

            // Event listener for handing mouseip. Toggles draw off
            containerID.addEventListener('mouseup', e => {
                if (!e.button) activeMouse = false
            })

            // Event listener for reset button click. Selects grid size
            let resetContainer = document.getElementById("resetInput")
            resetContainer.addEventListener('click', () => {
                let gridSize = selectGridSize()
                if(gridSize) {
                    generateGrid(gridSize)
                    resetContainer.value = "Reset"
                    activeMouse = false
                }
            })

            // Event listener for random button. Fills RGB grid randomly 
            let radomContainer = document.getElementById("randomInput")
            radomContainer.addEventListener('click', () => {
                let divContainer = document.querySelectorAll("#container div")
                if (!divContainer.length) {
                    console.log("EMPTY")
                    alert("Please start the game and select a grid size.")
                }
                
                divContainer.forEach(div => {
                    let rgb = randomRGB()
                    let r = rgb[0], g = rgb[1], b = rgb[2]
                    let r10 = r/10, g10 = g/10, b10 =b/10

                    div.setAttribute('r', r)
                    div.setAttribute('g', g)
                    div.setAttribute('b', b)
                    div.setAttribute('r10', r10)
                    div.setAttribute('g10', g10)
                    div.setAttribute('b10', b10)

                    div.style.backgroundColor=colourRGB(r, g, b)
                })
            })


            // Creates grid based on desired gridsize.
            function generateGrid(gridSize) {
                containerID.innerHTML = '' //Clear grid
                containerID.style.width = 600 + "px"
                containerID.style.height = 600 + "px"
                let containerWidth = containerID.clientWidth
                let containerHeight = containerID.clientHeight

                // Check if required grid size will fit into original 600pxx600px container. If not, find excess and subtract from original container.
                if (containerWidth%gridSize != 0 ||
                    containerHeight%gridSize != 0) {
                        containerID.style.width = containerWidth - containerWidth%gridSize + "px"
                        containerID.style.height = containerHeight - containerHeight%gridSize + "px"

                        containerWidth = containerID.clientWidth
                        containerHeight = containerID.clientHeight
                }

                let boxWidth = Math.floor(containerWidth/gridSize)
                let boxHeight= Math.floor(containerHeight/gridSize)

                // Create rows and columns based of chosen grid size
                for (let i = 0; i < gridSize; i++) {
                    for (let j = 0; j < gridSize; j++) {
                        let div = document.createElement("div")
                        let rgb
                        let r, r10
                        let g, g10
                        let b, b10

                        div.style.width = boxWidth + "px"
                        div.style.height = boxHeight + "px"
                        div.style.background = defaultColour

                        // Add mouseover event handler to colour in blocks if button is pressed, or shade by 10% if already coloured
                        div.addEventListener('mouseover', () => {
                            if (activeMouse) {
                                if (div.style.background == defaultColour) {
                                    rgb = randomRGB()
                                    r = rgb[0], g = rgb[1], b = rgb[2]
                                    r10 = r/10, g10 = g/10, b10 =b/10

                                    div.setAttribute('r', r)
                                    div.setAttribute('g', g )
                                    div.setAttribute('b', b)
                                    div.setAttribute('r10', r10)
                                    div.setAttribute('g10', g10)
                                    div.setAttribute('b10', b10)

                                    div.style.backgroundColor = colourRGB(r, g, b)
                                }
                                else {                                  
                                    r = div.getAttribute('r') - 
                                        div.getAttribute('r10')

                                    g = div.getAttribute('g') - 
                                        div.getAttribute('g10')

                                    b = div.getAttribute('b') - 
                                        div.getAttribute('b10')

                                    div.setAttribute('r', r)
                                    div.setAttribute('g', g)
                                    div.setAttribute('b', b)

                                    div.style.backgroundColor = colourRGB(r, g, b)
                                }
                            }                            
                        })
                        containerID.appendChild(div)
                    }
                let jump = document.createElement("br")
                document.getElementById("container").appendChild(jump)
                }
            }

            // Promt uset to select a grid size.
            function selectGridSize() {
                while (true) {
                    selection = window.prompt("Select Grid Size (default is 10x10)", 10)
                    if (checkIfNull(selection)) return 0

                    selectionClean = numberCleanup(selection)
                    if (checkIfValidNumber(selectionClean)) return selectionClean
                }
            }

            function checkIfNull(input) {
                return (input === null) ? true : false
            }

            function numberCleanup(number) {
                return Number(number.trim())
            }

            function checkIfValidNumber(number) {
                return isNaN(number) ? false : true
            }

            // Generates random rgb value and returns array
            function randomRGB() {
                let p = Math.round, q = Math.random, r = 255;
                return [p(q()*r), p(q()*r), p(q()*r)]
            }

            // Form rgb values into string and return
            function colourRGB(r, g, b) {
                return 'rgb(' + r + ',' + g + ',' + b + ')'
            }

            // Prevents drag selection when pressing down on recently colour block
            function clearSelection() {
                if (window.getSelection) {window.getSelection().removeAllRanges();}
                else if (document.selection) {document.selection.empty();}
            }
        </script>
    </body>
</html>