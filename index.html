<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Calculator</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="styles/style.css">
    </head>
    <body>
        <div id="display">
            <label> The output is: </label>
            <output id="displayOutput" name="myOutput"></output>
        </div>

        <div id = "buttons" >
            <input id="decimalInput" class="operand" value="." type="button">
            <input id="zeroInput" class="operand" value="0" type="button">
            <input id="oneInput" class="operand" value="1" type="button">
            <input id="twoInput" class="operand" value="2" type="button">
            <input id="threeInput" class="operand" value="3" type="button">
            <input id="fourInput" class="operand" value="4" type="button">
            <input id="fiveInput" class="operand" value="5" type="button">
            <input id="sixInput" class="operand" value="6" type="button">
            <input id="seventInput" class="operand" value="7" type="button">
            <input id="eightInput" class="operand" value="8" type="button">
            <input id="nineInput" class="operand" value="9" type="button">
            <input id="addInput" class="signOperator" value="+" type="button">
            <input id="subtractInput" class="signOperator" value="-" type="button">
            <input id="multiplyInput" class="signOperator" value="x" type="button">
            <input id="divideInput" class="signOperator" value="/" type="button">
            <input id="equalInput" class="signOperator" value="=" type="button">
            <input id="openBracketInput" class="operator" value="(" type="button">
            <input id="closeBracketInput" class="operator" value=")" type="button">
            <input id="ClearInput" class="operator" value="Clear" type="button">
            <input id="BackInput" class="operator" value="Back" type="button">
        </div>

        <script>
            let decimalAllowed = true // To check if decimal can be places
            let bracketOpened = 0 // Track how many brackets have been opened
            let outputID = document.getElementById("displayOutput") // Output handle
            outputID.textContent = ""

            // Event handler for numeric operands 0-9
            let operandContainer = document.querySelectorAll(".operand")
            operandContainer.forEach(operand => {
                operand.addEventListener('click', (e) => {
                    operand = e.target.value

                    if(operand != "." || decimalAllowed) {
                        if (operand == ".") decimalAllowed = false
                        
                        outputID.textContent += operand
                    }  
                })
            })

            // Event handler for sign operators "+", "-", "*", "/"
            let signOperatorContainer = document.querySelectorAll(".signOperator")
            signOperatorContainer.forEach(signOperator => {
                signOperator.addEventListener('click', (e) => {
                    operator = e.target.value

                    if (operator == "=") {
                        const expression = outputID.textContent
                        let expressionCalc = operate(expression)

                        // If divided by zero, send message to user
                        if (expressionCalc == "Infinity") {
                            outputID.textContent = "Not gonna happen"
                            return
                        }
                        
                        // If float, truncate to 3 decimal places
                        if (isFloat(expressionCalc)) {
                            expressionCalc = expressionCalc.toFixed(3)
                        }

                        outputID.textContent = expressionCalc
                    }
                    else {
                        const signOperators = ['+', '-', 'x', '/']
                        // If previous character is sign or blank, then do not accept sign input. Prevents scenarios such as 4++3 or 8*/2
                        if (signOperators.indexOf(getPreviousCharacter()) == -1 &&
                            getPreviousCharacter() != "") {
                            outputID.textContent += operator
                            decimalAllowed = true
                        }
                    }
                })
            })

            // Event handler called for operators "(", ")", "Back", and "Clear"
            let operatorContainer = document.querySelectorAll(".operator")
                operatorContainer.forEach(operator => {
                    operator.addEventListener('click', (e) => {
                        operator = e.target.value

                        console.log(bracketOpened)
                        // If back, remove last element from output
                        if (operator == "Back") {
                            if (getPreviousCharacter() == ")") bracketOpened++
                            if (getPreviousCharacter() == "(") bracketOpened--
                            outputID.textContent = outputID.textContent.slice(0, -1)
                        }
                        // If open bracket, increment bracket counter
                        else if (operator == "(") {
                            outputID.textContent += operator
                            bracketOpened++
                        }
                        // If close bracket, make sure open bracket does not immediately preceed it. Avoids scanarios like "()"
                        else if (operator == ")"){
                            if (bracketOpened && getPreviousCharacter() != "(") {                          
                                outputID.textContent += operator
                                bracketOpened--
                            }
                        }
                        // If clear, erase display and allow decimals to be used
                        else if (operator == "Clear") {
                            outputID.textContent = ""
                            decimalAllowed = true
                        }
                        else {
                            outputID.textContent += operator
                        }
                    })
                })

            function operate(str) {
                // Finds and replaces "x" multiply symbol with "*"
                const regexMultiplySign = /x/g 
                // Finds opening brackets preceded by a numeric or decimal e.g. 56(10) in order to replace with "*(" e.g. 56*(10)
                const regexOpeningBracket = /(?<=[0-9\.\)])\(/g
                // Finds closing brackets succeeded by a numeric or decimal e.g. (10).1 in order to replace with ")*" e.g. (10)*.1
                const regexClosingBracket = /\)(?=[0-9\.\()])/g
                
                // Replace necessary "x", "(", ")" symbols with appropriate symbol
                const strRegex = str
                            .replace(regexMultiplySign, '*')
                            .replace(regexOpeningBracket, '*(')
                            .replace(regexClosingBracket, ')*')

                // const string = "3%"
                // console.log(string)

                // Evaulate arithmetic string and return value
                return Function(`'use strict'; return (${strRegex})`)()
            }

            // Checks if value is float
            function isFloat(n) {
                return n % 1 ? true : false
            }

            function getPreviousCharacter() {
                return outputID.textContent.slice(-1)
            }

        </script>
    </body>
</html>